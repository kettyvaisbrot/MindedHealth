<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Log {{ category|capfirst }}</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f7f7f7;
            padding: 2rem;
        }
        .chat-container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .question {
            margin: 1rem 0;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }
        button:hover {
            background-color: #45a049;
        }
        .answer-options {
            margin-top: 0.5rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h2>Log {{ category|capfirst }}</h2>

    <div id="start-section">
        <button id="start-btn">Start</button>
    </div>

    <form id="chat-form" class="hidden" method="POST">
        {% csrf_token %}
        <div id="question-box"></div>
        <div class="answer-options" id="answer-options"></div>
    </form>
</div>

<script>
    let questions = [];
    let currentQuestionIndex = 0;
    const answers = {};

    const startBtn = document.getElementById("start-btn");
    const startSection = document.getElementById("start-section");
    const chatForm = document.getElementById("chat-form");
    const questionBox = document.getElementById("question-box");
    const answerOptions = document.getElementById("answer-options");

    const urlParams = new URLSearchParams(window.location.search);
    const force = urlParams.get("force") === "true";
    const edit = urlParams.get("edit") === "true";

    startBtn.addEventListener("click", () => {
        startSection.classList.add("hidden");
        chatForm.classList.remove("hidden");
        fetchQuestions().then(() => showNextQuestion());
    });

    async function fetchQuestions() {
        const category = "{{ category }}";
        let fetchUrl = `/dashboard/api/chat/${category}/?`;
        if (force) fetchUrl += "force=true&";
        if (edit) fetchUrl += "edit=true";

        try {
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.questions) {
                questions = data.questions;
            } else if (data.summary) {
                alert("✅ You've already logged medication today.");
                window.location.href = "{% url 'dashboard:dashboard_home' %}";
            } else if (data.message) {
                alert("✅ Log already exists.");
                window.location.href = "{% url 'dashboard:dashboard_home' %}";
            } else {
                alert("⚠️ No questions found.");
            }
        } catch (error) {
            alert("⚠️ Error fetching questions: " + error.message);
        }
    }

    function showNextQuestion() {
        while (currentQuestionIndex < questions.length) {
            const q = questions[currentQuestionIndex];

            if (q.condition) {
                const prevAnswer = answers[q.condition.field];
                if (prevAnswer !== q.condition.value) {
                    currentQuestionIndex++;
                    continue;
                }
            }

            // Safely create question element instead of using innerHTML
            questionBox.innerHTML = "";
            const questionDiv = document.createElement("div");
            questionDiv.className = "question";
            questionDiv.textContent = q.question;
            questionBox.appendChild(questionDiv);

            answerOptions.innerHTML = "";

            if (q.type === "boolean" || q.type === "bool") {
                const yesBtn = document.createElement("button");
                yesBtn.type = "button";
                yesBtn.textContent = "Yes";
                yesBtn.onclick = () => handleAnswer(q.field, "yes");

                const noBtn = document.createElement("button");
                noBtn.type = "button";
                noBtn.textContent = "No";
                noBtn.onclick = () => handleAnswer(q.field, "no");

                answerOptions.appendChild(yesBtn);
                answerOptions.appendChild(noBtn);

            } else if (q.type === "select" && Array.isArray(q.options)) {
                q.options.forEach(option => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.textContent = option;
                    btn.onclick = () => handleAnswer(q.field, option);
                    answerOptions.appendChild(btn);
                });

            } else {
                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = "Enter your answer";
                input.id = "answer-input";

                const submitBtn = document.createElement("button");
                submitBtn.type = "button";
                submitBtn.textContent = "Submit";
                submitBtn.onclick = () => {
                    if (!input.value.trim()) {
                        alert("Please enter an answer");
                        return;
                    }
                    handleAnswer(q.field, input.value.trim());
                };

                answerOptions.appendChild(input);
                answerOptions.appendChild(submitBtn);
            }

            return;
        }

        questionBox.innerHTML = "<p>✅ All done!</p>";
        answerOptions.innerHTML = "";
        submitAnswers();
    }

    function handleAnswer(field, answer) {
        answers[field] = answer;

        const currentQuestion = questions[currentQuestionIndex];
        let next = currentQuestionIndex + 1;

        if (currentQuestion.next_if && currentQuestion.next_if[answer] !== undefined) {
            next = currentQuestion.next_if[answer];

            if (next === "end") {
                window.location.href = "/dashboard/"; // or your desired end route
                return;
            }

            // Convert to integer in case it's a string number like "4"
            next = parseInt(next, 10);
        }

        currentQuestionIndex = next;
        showNextQuestion();
    }

    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('csrftoken=')) {
                return decodeURIComponent(cookie.substring('csrftoken='.length));
            }
        }
        return null;
    }

    function submitAnswers() {
        const category = "{{ category }}";
        fetch(`/dashboard/log/${category}/chat/submit/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify(answers)
        })
        .then(response => {
            if (response.ok) {
                alert("✅ Log saved successfully!");
                window.location.href = "{% url 'dashboard:dashboard_home' %}";
            } else {
                return response.json().then(data => {
                    const errorMsg = data?.error || "❌ Error saving log.";
                    alert(errorMsg);
                });
            }
        })
        .catch(() => alert("❌ Error sending data to server."));
    }
</script>

</body>
</html>
